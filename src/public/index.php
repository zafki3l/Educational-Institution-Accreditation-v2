<?php

use App\Shared\Response\JsonResponse;
use App\Shared\Response\ViewResponse;
use Core\Router;
use Core\ViewRender;

require_once '../configs/path.php';
require_once '../configs/name.php';
require_once '../helpers/authHelper.php';

require dirname(__DIR__, 2) . '/vendor/autoload.php';

require_once '../bootstrap/app.php';

$route = new Router();

$rootPath = '/' . basename(dirname(__DIR__));
$path = str_replace($rootPath, '', parse_url($_SERVER['REQUEST_URI'], PHP_URL_PATH));

foreach (glob(dirname(__DIR__) . '/routes/*.php') as $filename) {
    require_once $filename;
}

$response = $route->dispatch($path, $_SERVER['REQUEST_METHOD']);

if ($response instanceof ViewResponse) {
    $viewRender = new ViewRender();

    $viewRender->view($response);
} else if ($response instanceof JsonResponse) {
    $response->send();
} else {
    throw new \Exception('Response not valid');
}